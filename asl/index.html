<!doctype html>
<html lang="en">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet"
href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
crossorigin="anonymous">
<link rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
crossorigin="anonymous">
<link rel="stylesheet" href="../css/page.css">

<title>Atlas</title>
</head>
<body>
<header class="navbar navbar-expand-lg navbar-dark" id="nav-top">
<a class="navbar-brand" href="../index.html">
<img src="../images/atlas_logo_small.png" width="40px" height="40px"/>
</a>
<button class="navbar-toggler"
type="button"
data-toggle="collapse"
data-target="#navbarSupportedContent"
aria-controls="navbarSupportedContent"
aria-expanded="false"
aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>

<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul class="navbar-nav mr-auto">
<li class="nav-item active">
<a class="nav-link" href="../index.html">
<span style="font-size: 1.8em;">Atlas</span>
</a>
</li>
</ul>
<button type="button" class="btn btn-outline-light" data-toggle="modal" data-target="#search-modal">
<span class="fa fa-search"></span>
</button>
</div>
</header>

<div id="search-modal" class="modal" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document">
<div class="modal-content">
<div class="modal-header">
<form style="min-width: 100%">
<input class="form-control form-control-sm" id="search" type="text" autocomplete="off">
</form>
</div>
<div class="modal-body">
<div id="search-results"></div>
</div>
</div>
</div>
</div>

<div class="container-fluid">
<div class="row flex-xl-nowrap justify-content-md-center">
<div class="col-12 col-md-3 col-xl-2" id="nav-left">
<select class="supergroup" name="Language"><option class="group" value="group-java">Java</option><option class="group" value="group-python">Python</option></select>
<ul>
  <li><a href="../overview.html" class="page">Overview</a></li>
  <li><a href="../getting-started.html" class="page">Getting Started</a></li>
  <li><a href="../concepts.html" class="page">Concepts</a></li>
  <li><a href="../presentations.html" class="page">Presentations</a></li>
  <li><a href="../asl/index.html" class="active page">Stack Language</a>
  <ul>
    <li><a href="../asl/alerting.html" class="page">Alerting Expressions</a></li>
    <li><a href="../asl/alerting-philosophy.html" class="page">Alerting Philosophy</a></li>
    <li><a href="../asl/des.html" class="page">Double Exponential Smoothing</a></li>
  </ul></li>
  <li><a href="../asl-reference/index.html" class="page">Stack Language Reference</a>
  <ul>
    <li><a href="../asl-reference/and.html" class="page">and</a></li>
    <li><a href="../asl-reference/dist-avg.html" class="page">dist-avg</a></li>
    <li><a href="../asl-reference/eq.html" class="page">eq</a></li>
  </ul></li>
  <li><a href="../spectator/index.html" class="page">Spectator</a>
  <ul>
    <li><a href="../spectator/registry.html" class="page">Registry</a></li>
    <li><a href="../spectator/counters.html" class="page">Counters</a></li>
    <li><a href="../spectator/timers.html" class="page">Timers</a></li>
    <li><a href="../spectator/dist-summaries.html" class="page">Distribution Summaries</a></li>
    <li><a href="../spectator/gauges.html" class="page">Gauges</a></li>
    <li><a href="../spectator/clock.html" class="page">Clock</a></li>
    <li><a href="../spectator/testing.html" class="page">Testing</a></li>
    <li><a href="../spectator/netflix.html" class="page">Netflix Integration</a></li>
    <li><a href="../spectator/conventions.html" class="page">Names</a></li>
    <li><a href="../spectator/servo.html" class="page">Servo Comparison</a></li>
  </ul></li>
  <li><a href="../spectator-ext/index.html" class="page">Spectator Extensions</a>
  <ul>
    <li><a href="../spectator-ext/jvm-buffer-pools.html" class="page">Buffer Pools</a></li>
    <li><a href="../spectator-ext/jvm-gc.html" class="page">Garbage Collection</a></li>
    <li><a href="../spectator-ext/jvm-gc-causes.html" class="page">GC Causes</a></li>
    <li><a href="../spectator-ext/jvm-memory-pools.html" class="page">Memory Pools</a></li>
    <li><a href="../spectator-ext/thread-pools.html" class="page">Thread Pools</a></li>
    <li><a href="../spectator-ext/log4j1.html" class="page">Log4j1 Appender</a></li>
    <li><a href="../spectator-ext/log4j2.html" class="page">Log4j2 Appender</a></li>
    <li><a href="../spectator-ext/placeholders.html" class="page">Placeholders</a></li>
  </ul></li>
  <li><a href="../spectator-reg/index.html" class="page">Spectator Registries</a>
  <ul>
    <li><a href="../spectator-reg/metrics3.html" class="page">Metrics3 Registry</a></li>
    <li><a href="../spectator-reg/servo.html" class="page">Servo Registry</a></li>
  </ul></li>
</ul>
</div>
<div class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5" id="content">
<h1><a href="#stack-language" name="stack-language" class="anchor"><span class="anchor-link"></span></a>Stack Language</h1>
<p>Atlas Stack Language is designed to be a stable method of representing complex data queries in a URL-friendly format. It is loosely based on the <a href="http://oss.oetiker.ch/rrdtool/doc/rrdgraph_rpn.en.html">RPN expressions</a> supported by <a href="https://tobi.oetiker.ch/hp/">Tobias Oetiker</a>&rsquo;s <a href="http://oss.oetiker.ch/rrdtool/">rrdtool</a>. The following is an example of a stack language expression:</p>
<p><code>nf.cluster,discovery,:eq,(,nf.zone,),:by</code></p>
<p>This example pushes two strings nf.cluster and discovery onto the stack and then executes the command :eq. The equal command pops two strings from the stack and pushes a query object onto the stack. The behavior can be described by the stack effect String:key String:value â€“ Query. We then push a list of tag keys to the stack and execute the command :by to group the results.</p>
<h2><a href="#parts" name="parts" class="anchor"><span class="anchor-link"></span></a>Parts</h2>
<p>There are only four reserved symbols used for structuring the expression: <code>,:()</code></p>
<ol>
  <li>Commas separate items on the stack. So <code>a,b</code> puts two strings on the stack with values <code>&quot;a&quot;</code>  and <code>&quot;b&quot;</code>.</li>
  <li>Colon is used to prefix operations. If the first character is a colon the item will be treated  as a command to run. For example, <code>a,:dup</code>, will push <code>&quot;a&quot;</code> on the stack and then execute the  <a href="std-dup">duplicate</a> operation.</li>
  <li>Parenthesis are used to indicate the start and end of a list. The expression <code>(,)</code> puts an  empty list on the stack. Commands inside of a list will not be executed unless the list is  passed to the <a href="std-call">call</a> command. For example, <code>(,:dup,)</code> will push a list with a single  string value of <code>&quot;:dup&quot;</code> on to the stack.</li>
</ol>
<h2><a href="#data-model" name="data-model" class="anchor"><span class="anchor-link"></span></a>Data Model</h2>
<p>The stack language is primarily used for representing expressions over tagged time series data. A tag is a string key value pair used to describe a measurement. Atlas requires at least one tag with a key of <code>name</code>. Example tags represented as a JSON map:</p>
<pre class="prettyprint"><code class="language-json">{
  &quot;name&quot;:       &quot;jvm.gc.pause&quot;,
  &quot;cause&quot;:      &quot;Allocation_Failure&quot;,
  &quot;statistic&quot;:  &quot;count&quot;,
  &quot;nf.app&quot;:     &quot;www&quot;,
  &quot;nf.cluster&quot;: &quot;www-main&quot;,
  &quot;nf.asg&quot;:     &quot;www-main-v001&quot;,
  &quot;nf.stack&quot;:   &quot;main&quot;,
  &quot;nf.node&quot;:    &quot;i-01&quot;,
  &quot;nf.region&quot;:  &quot;us-east-1&quot;,
  &quot;nf.zone&quot;:    &quot;us-east-1a&quot;
}
</code></pre>
<p>Typically tags should be dimensions that allow you to use the name as a pivot and other tags to drill down into the data. The tag keys are similar to columns in a traditional table, however, it is important to note that not all time series will have the same set of tag keys.</p>
<p>The tags are used to identify a time series, which conceptually is a set of timestamp value pairs. Here is a simplified data set shown as a table:</p>
<table>
  <thead>
    <tr>
      <th>name </th>
      <th>app </th>
      <th>node </th>
      <th>values </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cpuUsage </td>
      <td>www </td>
      <td>i-01 </td>
      <td>[(05:00, 33.0), (05:01, 31.0)] </td>
    </tr>
    <tr>
      <td>cpuUsage </td>
      <td>www </td>
      <td>i-02 </td>
      <td>[(05:00, 20.0), (05:01, 37.0)] </td>
    </tr>
    <tr>
      <td>cpuUsage </td>
      <td>db </td>
      <td>i-03 </td>
      <td>[(05:00, 57.0), (05:01, 62.0)] </td>
    </tr>
    <tr>
      <td>diskUsage </td>
      <td>www </td>
      <td>i-01 </td>
      <td>[(05:00, 9.0), (05:01, 9.0)] </td>
    </tr>
    <tr>
      <td>diskUsage </td>
      <td>www </td>
      <td>i-02 </td>
      <td>[(05:00, 7.0), (05:01, 8.0)] </td>
    </tr>
    <tr>
      <td>requestRate </td>
      <td>www </td>
      <td> </td>
      <td>[(05:00, 33.0), (05:01, 31.0)] </td>
    </tr>
  </tbody>
</table>
<p>The table above will be used for the examples in later sections.</p>
<h2><a href="#simple-expressions" name="simple-expressions" class="anchor"><span class="anchor-link"></span></a>Simple Expressions</h2>
<p>All expressions generally have four parts:</p>
<ol>
  <li><strong>Query:</strong> selects a set of time series.</li>
  <li><strong>Aggregation:</strong> defines how to combine the selected time series.</li>
  <li><strong>Math:</strong> manipulate the time series values or combine aggregated results with binary operations.</li>
  <li><strong>Presentation:</strong> adjust how the data is presented in a chart.</li>
</ol>
<h3><a href="#query" name="query" class="anchor"><span class="anchor-link"></span></a>Query</h3>
<p>The query is used to select a set of time series. The primary query operators are <a href="query-eq">:eq</a> and <a href="query-and">:and</a>. For a full list see the <a href="Stack-Language-Reference">query section</a> of the reference page.</p>
<p>Sample query to select all time series where the key <code>node</code> is equal to <code>i-01</code>:</p>
<pre><code>node,i-01,:eq
</code></pre>
<p>If you are familiar with SQL and assume that tag keys are column names, then this would be equivalent to:</p>
<pre><code>select * from time_series where node = &#39;i-01&#39;;
</code></pre>
<p>Using the <a href="#data-model">example data set</a> this query would return the following subset:</p>
<table>
  <thead>
    <tr>
      <th>name </th>
      <th>app </th>
      <th>node </th>
      <th>values </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cpuUsage </td>
      <td>www </td>
      <td>i-01 </td>
      <td>[(05:00, 33.0), (05:01, 31.0)] </td>
    </tr>
    <tr>
      <td>diskUsage </td>
      <td>www </td>
      <td>i-01 </td>
      <td>[(05:00, 9.0), (05:01, 9.0)] </td>
    </tr>
  </tbody>
</table>
<p>To get just the cpu usage for that node, use <a href="query-and">:and</a>:</p>
<pre><code>node,i-01,:eq,name,cpuUsage,:eq,:and
</code></pre>
<p>This would result in:</p>
<table>
  <thead>
    <tr>
      <th>name </th>
      <th>app </th>
      <th>node </th>
      <th>values </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cpuUsage </td>
      <td>www </td>
      <td>i-01 </td>
      <td>[(05:00, 33.0), (05:01, 31.0)] </td>
    </tr>
  </tbody>
</table>
<h3><a href="#aggregation" name="aggregation" class="anchor"><span class="anchor-link"></span></a>Aggregation</h3>
<p>An aggregation function maps a set of time series that matched the query to a single time series. Atlas supports four aggregate functions: <a href="data-sum">sum</a>, <a href="data-min">min</a>, <a href="data-max">max</a>, and <a href="data-count">count</a>. If no aggregate is specified on an expression, then <a href="data-sum">sum</a> will be used implicitly.</p>
<p>Using the <a href="#data-model">example data set</a>, these two expressions would be equivalent:</p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and
app,www,:eq,name,cpuUsage,:eq,:and,:sum
</code></pre>
<p>And would result in a single output time series:</p>
<table>
  <thead>
    <tr>
      <th>name </th>
      <th>app </th>
      <th>values </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cpuUsage </td>
      <td>www </td>
      <td>[(05:00, 53.0), (05:01, 68.0)] </td>
    </tr>
  </tbody>
</table>
<p>Note that the node is not present in the output. The set of tags on the output will be ones with exact matches in the query clause or explicitly listed in the <a href="#group-by">group by</a>.</p>
<p>If you wanted the max cpu for the application, then you would write:</p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and,:max
</code></pre>
<p>What if we want the average? The <a href="data-count">count</a> aggregate is used to determine how many time series had a value for a given time. To get the average we divide the sum by the count. </p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and,
:dup,
:sum,
:swap,
:count,
:div
</code></pre>
<p>There is a helper macro <a href="math-avg">:avg</a> that will do this for you, so you can write:</p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and,:avg
</code></pre>
<h3><a href="#group-by" name="group-by" class="anchor"><span class="anchor-link"></span></a>Group By</h3>
<p>In many cases we want to group the results that were selected and return one aggregate per group. As an example suppose I want to see maximum cpu usage by application:</p>
<pre><code>name,cpuUsage,:eq,:max,(,app,),:by
</code></pre>
<p>Using the <a href="#data-model">example data set</a>, this would result in a two output time series:</p>
<table>
  <thead>
    <tr>
      <th>name </th>
      <th>app </th>
      <th>values </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cpuUsage </td>
      <td>www </td>
      <td>[(05:00, 33.0), (05:01, 37.0)] </td>
    </tr>
    <tr>
      <td>cpuUsage </td>
      <td>db </td>
      <td>[(05:00, 57.0), (05:01, 62.0)] </td>
    </tr>
  </tbody>
</table>
<h3><a href="#math" name="math" class="anchor"><span class="anchor-link"></span></a>Math</h3>
<p>Once you have a set of lines, it can be useful to manipulate them. The supported operations generally fall into two categories: unary operations to alter a single time series and binary operations that combine two time series.</p>
<p>Examples of unary operations are <a href="math-neg">negate</a> and <a href="math-abs">absolute value</a>. To apply the absolute value:</p>
<pre><code>app,web,:eq,name,cpu,:eq,:and,:sum,:abs
</code></pre>
<p>Multiple operations can be applied, for example, negating the line then applying the absolute value:</p>
<pre><code>app,web,:eq,name,cpu,:eq,:and,:sum,:neg,:abs
</code></pre>
<p>Common binary operations are <a href="math-add">add</a>, <a href="math-sub">subtract</a>, <a href="math-mul">multiply</a>, and <a href="math-div">divide</a>. The <a href="#aggregation">aggregation section</a> has an example of using divide to compute the average.</p>
<p>For a complete list see the <a href="Stack-Language-Reference">math section</a> of the reference page.</p>
<h3><a href="#presentation" name="presentation" class="anchor"><span class="anchor-link"></span></a>Presentation</h3>
<p>Once you have a final expression, you can apply presentation settings to alter how a time series is displayed in the chart. One of the most common examples is setting the label to use for the <a href="style-legend">legend</a>:</p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and,:avg,
average cpu usage,:legend
</code></pre>
<p>You can also use tag keys as variables in the legend text, for example, setting the legend to the application:</p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and,:avg,(,app,),:by,
$(app),:legend
</code></pre>
<p>It is also common to adjust the how the lines are shown. For example, to stack each of the lines we can use the <a href="style-stack">:stack</a> command to adjust the line style:</p>
<pre><code>app,www,:eq,name,cpuUsage,:eq,:and,:avg,(,app,),:by,
:stack,
$(app),:legend
</code></pre>
<p>For a complete list see the <a href="Stack-Language-Reference">style section</a> of the reference page.</p>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../asl/alerting.html">Alerting Expressions</a></p>
</div>
</div>
<div class="d-none d-xl-block col-xl-2" id="nav-right">
<ul>
  <li><a href="../asl/index.html#stack-language" class="header">Stack Language</a>
  <ul>
    <li><a href="../asl/index.html#parts" class="header">Parts</a></li>
    <li><a href="../asl/index.html#data-model" class="header">Data Model</a></li>
    <li><a href="../asl/index.html#simple-expressions" class="header">Simple Expressions</a>
    <ul>
      <li><a href="../asl/index.html#query" class="header">Query</a></li>
      <li><a href="../asl/index.html#aggregation" class="header">Aggregation</a></li>
      <li><a href="../asl/index.html#group-by" class="header">Group By</a></li>
      <li><a href="../asl/index.html#math" class="header">Math</a></li>
      <li><a href="../asl/index.html#presentation" class="header">Presentation</a></li>
    </ul></li>
  </ul></li>
</ul>
</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/lunr@2.1.6/lunr.js"
integrity="sha256-U3smMZ6uKxtHEAX38FWHzhjlVgfcm5Xvs0Gp8t3unQk="
crossorigin="anonymous"></script>
<script src="../js/page.js"></script>

<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=scala"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
</body>
</html>
